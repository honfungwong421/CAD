<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCQ Master</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-800">

    <!-- Navigation -->
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold"><i class="fas fa-graduation-cap mr-2"></i>MCQ Master</h1>
            <div class="space-x-4">
                <button onclick="app.navigate('home')" class="hover:text-blue-200 transition">Banks</button>
                <button onclick="app.navigate('import')" class="hover:text-blue-200 transition">Import</button>
                <button onclick="app.navigate('debug')" class="text-xs bg-red-500 px-2 py-1 rounded hover:bg-red-600 transition">Helper</button>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="container mx-auto px-4 py-6" id="app-container">
        <!-- Views will be injected here -->
    </main>

    <!-- Templates -->
    <template id="view-home">
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-700">Question Banks</h2>
                <div class="space-x-2">
                    <button onclick="app.navigate('import')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded shadow">
                        <i class="fas fa-plus mr-2"></i>New Bank
                    </button>
                </div>
            </div>
            
            <div id="bank-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Banks injected here -->
            </div>
            
            <div id="empty-state" class="hidden text-center py-12 bg-white rounded-lg shadow">
                <i class="fas fa-folder-open text-gray-300 text-5xl mb-4"></i>
                <p class="text-gray-500">No question banks found. Import a PDF to get started!</p>
            </div>
        </div>
    </template>

    <template id="view-import">
        <div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-6 text-gray-700">Import Questions</h2>
            
            <div class="space-y-6">
                <!-- PDF Import -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition cursor-pointer" onclick="document.getElementById('pdf-upload').click()">
                    <i class="fas fa-file-pdf text-red-500 text-4xl mb-3"></i>
                    <h3 class="font-semibold text-lg">Upload PDF</h3>
                    <p class="text-gray-500 text-sm">Extract questions automatically</p>
                    <input type="file" id="pdf-upload" class="hidden" accept="application/pdf" onchange="app.handlePdfUpload(this)">
                </div>

                <!-- JSON Import -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-green-500 transition cursor-pointer" onclick="document.getElementById('json-upload').click()">
                    <i class="fas fa-file-code text-green-500 text-4xl mb-3"></i>
                    <h3 class="font-semibold text-lg">Upload JSON</h3>
                    <p class="text-gray-500 text-sm">Import exported question bank</p>
                    <input type="file" id="json-upload" class="hidden" accept=".json" onchange="app.handleJsonUpload(this)">
                </div>
            </div>

            <div id="import-status" class="mt-6 hidden">
                <div class="flex items-center justify-center space-x-3 text-blue-600">
                    <div class="loader"></div>
                    <span>Processing file...</span>
                </div>
            </div>
            
            <div id="import-error" class="mt-6 hidden bg-red-50 border-l-4 border-red-500 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-circle text-red-500"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800">Something went wrong</h3>
                        <div class="mt-2 text-sm text-red-700" id="error-message"></div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="view-edit">
        <div class="space-y-4">
            <div class="flex justify-between items-center bg-white p-4 rounded-lg shadow">
                <div>
                    <h2 class="text-xl font-bold text-gray-700" id="edit-bank-title">Editing Bank</h2>
                    <span class="text-sm text-gray-500" id="edit-question-count">0 questions</span>
                </div>
                <div class="space-x-2">
                    <button onclick="app.saveBankEdit()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-save mr-2"></i>Save & Exit
                    </button>
                </div>
            </div>

            <div id="questions-editor" class="space-y-6">
                <!-- Questions injected here -->
            </div>
            
            <button onclick="app.addEmptyQuestion()" class="w-full py-3 border-2 border-dashed border-gray-300 text-gray-500 font-semibold rounded-lg hover:bg-gray-50 hover:border-gray-400 transition">
                <i class="fas fa-plus mr-2"></i>Add New Question
            </button>
        </div>
    </template>

    <template id="view-practice-setup">
        <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-md mt-10">
            <h2 class="text-2xl font-bold mb-6 text-gray-700 text-center">Practice Setup</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-bold mb-2">Mode</label>
                    <div class="flex space-x-2">
                        <button id="mode-std" onclick="app.setPracticeMode('standard')" class="flex-1 py-2 px-4 rounded border-2 border-blue-500 bg-blue-500 text-white">Standard</button>
                        <button id="mode-rds" onclick="app.setPracticeMode('rds')" class="flex-1 py-2 px-4 rounded border-2 border-gray-300 text-gray-600 hover:border-purple-500">Real Dope Shit</button>
                    </div>
                    <p id="mode-desc" class="text-xs text-gray-500 mt-1">Immediate feedback after every question.</p>
                </div>

                <div>
                    <label class="block text-gray-700 font-bold mb-2">Number of Questions</label>
                    <input type="number" id="practice-count" class="w-full border rounded px-3 py-2" min="1">
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="practice-shuffle" class="mr-2 h-5 w-5 text-blue-600">
                    <label for="practice-shuffle" class="text-gray-700">Shuffle Questions</label>
                </div>

                <button onclick="app.startPractice()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded mt-4">
                    Start Practice
                </button>
                
                 <div id="resume-container" class="hidden border-t pt-4 mt-4">
                     <button onclick="app.resumePractice()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded">
                        Resume Saved Session
                    </button>
                 </div>
            </div>
        </div>
    </template>

    <template id="view-practice">
        <div class="max-w-3xl mx-auto space-y-6">
            <!-- Header -->
            <div class="bg-white p-4 rounded-lg shadow flex justify-between items-center sticky top-0 z-10">
                <div class="text-lg font-bold">
                    Question <span id="p-current">1</span>/<span id="p-total">10</span>
                </div>
                <div class="text-lg font-bold" id="score-display">
                    Score: <span id="p-score" class="text-green-600">0</span>
                </div>
                <button onclick="app.saveAndQuit()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-save mr-1"></i> Save & Quit
                </button>
            </div>

            <!-- Question Card -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div id="p-question-text" class="text-lg font-medium mb-4 text-gray-800 leading-relaxed"></div>
                <div id="p-question-image" class="mb-4 hidden">
                    <img src="" class="max-w-full h-auto rounded border">
                </div>
                
                <div id="p-choices" class="space-y-3">
                    <!-- Choices -->
                </div>

                <div id="p-feedback" class="mt-6 hidden p-4 rounded-lg"></div>
            </div>

            <!-- Controls -->
            <div class="flex justify-between">
                <button onclick="app.prevQuestion()" class="bg-gray-300 text-gray-700 px-6 py-2 rounded hover:bg-gray-400">Previous</button>
                <button id="btn-next" onclick="app.nextQuestion()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Next</button>
                <button id="btn-submit-exam" onclick="app.submitExam()" class="hidden bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700">Submit Exam</button>
            </div>
        </div>
    </template>
    
    <template id="view-result">
        <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-md mt-10">
            <div class="text-center border-b pb-6 mb-6">
                <h2 class="text-3xl font-bold mb-2 text-gray-800">Practice Complete!</h2>
                <div class="text-6xl font-bold text-blue-600 my-6" id="result-score">80%</div>
                <p class="text-gray-600 mb-6" id="result-detail">You got 8 out of 10 correct.</p>
                <button onclick="app.navigate('home')" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Back to Home</button>
            </div>
            
            <div id="wrong-answers-section">
                <h3 class="text-xl font-bold text-gray-700 mb-4">Review Incorrect Answers</h3>
                <div id="result-wrong-list" class="space-y-4">
                    <!-- Wrong answers injected here -->
                </div>
            </div>
        </div>
    </template>

    <template id="view-debug">
        <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-4 text-gray-700"><i class="fas fa-bug mr-2 text-red-500"></i>Helper / Debugger</h2>
            <p class="mb-6 text-gray-600">If your PDF isn't importing correctly, upload it here. We'll examine it and tell you exactly what the computer sees.</p>
            
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-red-500 transition cursor-pointer mb-6" onclick="document.getElementById('debug-upload').click()">
                <i class="fas fa-microscope text-red-500 text-4xl mb-3"></i>
                <h3 class="font-semibold text-lg">Inspect PDF</h3>
                <input type="file" id="debug-upload" class="hidden" accept="application/pdf" onchange="app.runDebug(this)">
            </div>

            <div id="debug-output" class="hidden space-y-6">
                <div class="bg-blue-50 p-4 rounded border-l-4 border-blue-500">
                    <h3 class="font-bold text-blue-700">Analysis Report</h3>
                    <ul class="list-disc list-inside mt-2 text-sm text-blue-800 space-y-1" id="debug-report-list">
                    </ul>
                </div>
                
                <div>
                    <h3 class="font-bold text-gray-700 mb-2">Raw Text Lines Detected:</h3>
                    <div class="bg-gray-800 text-green-400 p-4 rounded font-mono text-xs h-64 overflow-y-auto" id="debug-log">
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        // Main Application Logic
        const app = {
            data: {
                banks: [],
                currentBankIndex: null,
                tempBank: null, // For editing
                practiceSession: null
            },
            
            init() {
                this.loadBanks();
                this.navigate('home');
                
                // Auto-sync from user's GitHub repository
                this.fetchExternalBanks();
                
                // Check for saved session
                const savedSession = localStorage.getItem('mcq_practice_session');
                if(savedSession) {
                    // Logic to show resume button handled in view setup
                }
            },

            async fetchExternalBanks() {
                const apiURL = "https://api.github.com/repos/honfungwong421/CAD/contents/bank";
                try {
                    const response = await fetch(apiURL);
                    if (!response.ok) return;
                    const files = await response.json();
                    
                    let newImports = false;
                    for (const file of files) {
                        if (file.name.endsWith('.json') && file.download_url) {
                            const bankName = file.name.replace('.json', '');
                            // Avoid duplicates by name
                            if (this.data.banks.some(b => b.name === bankName)) continue;

                            const contentResponse = await fetch(file.download_url);
                            if (contentResponse.ok) {
                                try {
                                    const bank = await contentResponse.json();
                                    if (bank.questions && Array.isArray(bank.questions)) {
                                        if (!bank.name) bank.name = bankName;
                                        this.data.banks.push(bank);
                                        newImports = true;
                                    }
                                } catch (err) {
                                    console.error("Invalid JSON content in " + file.name);
                                }
                            }
                        }
                    }
                    
                    if (newImports) {
                        this.saveBanks();
                        // Re-render if we are on the home screen
                        const bankList = document.getElementById('bank-list');
                        if (bankList) {
                            this.navigate('home'); 
                        }
                    }
                } catch (e) {
                    console.error("Failed to sync from GitHub:", e);
                }
            },

            loadBanks() {
                const saved = localStorage.getItem('mcq_banks');
                if (saved) {
                    this.data.banks = JSON.parse(saved);
                }
            },

            saveBanks() {
                localStorage.setItem('mcq_banks', JSON.stringify(this.data.banks));
            },

            navigate(view) {
                const container = document.getElementById('app-container');
                const template = document.getElementById(`view-${view}`);
                container.innerHTML = '';
                container.appendChild(template.content.cloneNode(true));

                if (view === 'home') this.renderHome();
                if (view === 'edit') this.renderEdit();
                if (view === 'practice-setup') this.renderPracticeSetup();
                if (view === 'practice') this.renderPractice();
                if (view === 'debug') this.renderDebug();
            },
            
            renderDebug() {
                // Just resets
            },

            async runDebug(input) {
                const file = input.files[0];
                if (!file) return;
                
                const output = document.getElementById('debug-output');
                const log = document.getElementById('debug-log');
                const reportList = document.getElementById('debug-report-list');
                
                output.classList.remove('hidden');
                log.innerHTML = "Reading file...";
                reportList.innerHTML = "";
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    
                    log.innerHTML = `PDF Loaded. Pages: ${pdf.numPages}\n------------------\n`;
                    
                    // We reuse the logic but instrument it
                    let totalLines = 0;
                    let potentialQuestions = 0;
                    let potentialChoices = 0;
                    let markersFound = 0;
                    let boldLines = 0;
                    
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        
                        const lines = {};
                        content.items.forEach(item => {
                            const y = Math.round(item.transform[5]);
                            if (!lines[y]) lines[y] = [];
                            lines[y].push({
                                text: item.str,
                                x: item.transform[4],
                                hasMark: item.str.includes('*'),
                                isBold: item.fontName.toLowerCase().includes('bold')
                            });
                        });
                        
                        const sortedY = Object.keys(lines).sort((a, b) => b - a);
                        
                        sortedY.forEach(y => {
                            lines[y].sort((a, b) => a.x - b.x);
                            const lineText = lines[y].map(item => item.text).join(' ').trim();
                            const hasMark = lines[y].some(item => item.hasMark);
                            const boldCount = lines[y].filter(i => i.isBold).length;
                            const isLineBold = lines[y].length > 0 && (boldCount / lines[y].length) > 0.5;
                            
                            if (lineText) {
                                totalLines++;
                                let note = "";
                                if (/^(\d+)[\.\)](.+)/.test(lineText)) { potentialQuestions++; note += " [Possible Question]"; }
                                if (/^(\(?[a-zA-Z]\)|[a-zA-Z]\.)(.+)/.test(lineText)) { potentialChoices++; note += " [Possible Choice]"; }
                                if (hasMark) { markersFound++; note += " [Marker Found *]"; }
                                if (isLineBold) { boldLines++; note += " [BOLD]"; }
                                
                                log.innerHTML += `Line ${totalLines}: ${lineText} ${note}\n`;
                            }
                        });
                    }
                    
                    // Generate Report
                    const addReport = (msg, isBad = false) => {
                        const li = document.createElement('li');
                        li.innerText = msg;
                        if(isBad) li.className = "text-red-600 font-bold";
                        reportList.appendChild(li);
                    };
                    
                    addReport(`Total text lines found: ${totalLines}`);
                    addReport(`Lines starting with numbers (Possible Questions): ${potentialQuestions}`);
                    addReport(`Lines looking like choices (a., b., etc.): ${potentialChoices}`);
                    
                    if (totalLines === 0) {
                        addReport("CRITICAL: No text found. This file is likely an image (scanned) or encrypted. We cannot read it.", true);
                    } else if (potentialQuestions === 0) {
                        addReport("CRITICAL: We found text, but no lines started with '1.' or '2)'. Please number your questions.", true);
                    } else if (potentialChoices === 0) {
                         addReport("WARNING: We found questions but no choices like 'a.' or '(b)'.", true);
                    } else {
                        addReport("GOOD: The file structure looks readable.");
                        if (markersFound === 0 && boldLines === 0) {
                            addReport("TIP: We didn't see any '*' markers or bold text. You might need to set correct answers manually.", true);
                        } else {
                            addReport(`We found ${markersFound} '*' markers and ${boldLines} bold lines to identify correct answers.`);
                        }
                    }
                    
                } catch (e) {
                    log.innerHTML += `\nERROR: ${e.message}`;
                    reportList.innerHTML = `<li class="text-red-600 font-bold">Fatal Error: ${e.message}</li>`;
                }
            },

            // --- Home View ---
            renderHome() {
                const list = document.getElementById('bank-list');
                const empty = document.getElementById('empty-state');
                
                if (this.data.banks.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }

                this.data.banks.forEach((bank, index) => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-6 rounded-lg shadow hover:shadow-md transition relative group';
                    card.innerHTML = `
                        <h3 class="font-bold text-lg mb-2 truncate">${bank.name}</h3>
                        <p class="text-gray-500 text-sm mb-4">${bank.questions.length} Questions</p>
                        <div class="flex flex-col space-y-2">
                            <button onclick="app.setupPractice(${index})" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-bold">Start Practice</button>
                            <div class="flex space-x-2">
                                <button onclick="app.editBank(${index})" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded hover:bg-gray-200 text-xs flex items-center justify-center"><i class="fas fa-edit mr-1"></i> Edit</button>
                                <button onclick="app.exportBank(${index})" class="flex-1 bg-green-100 text-green-700 py-2 rounded hover:bg-green-200 text-xs flex items-center justify-center"><i class="fas fa-file-export mr-1"></i> Export JSON</button>
                                <button onclick="app.copyBankToClipboard(${index})" class="flex-1 bg-blue-100 text-blue-700 py-2 rounded hover:bg-blue-200 text-xs flex items-center justify-center"><i class="fas fa-copy mr-1"></i> Copy JSON</button>
                                <button onclick="app.deleteBank(${index})" class="flex-1 bg-red-100 text-red-700 py-2 rounded hover:bg-red-200 text-xs flex items-center justify-center"><i class="fas fa-trash mr-1"></i> Delete</button>
                            </div>
                        </div>
                    `;
                    list.appendChild(card);
                });
            },

            // --- Import/Export ---
            async handlePdfUpload(input) {
                const file = input.files[0];
                if (!file) return;

                document.getElementById('import-status').classList.remove('hidden');
                document.getElementById('import-error').classList.add('hidden');

                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    
                    const questions = await this.parsePdf(pdf);
                    
                    if (questions.length === 0) {
                        throw new Error("We couldn't find any questions. Make sure questions start with numbers (like '1.') and the file isn't just pictures.");
                    }

                    const newBank = {
                        name: file.name.replace('.pdf', ''),
                        date: new Date().toISOString(),
                        questions: questions
                    };

                    this.data.banks.push(newBank);
                    this.saveBanks();
                    this.navigate('home');
                    
                } catch (e) {
                    this.showImportError(e);
                } finally {
                    document.getElementById('import-status').classList.add('hidden');
                    input.value = ''; // Reset
                }
            },

            async handleJsonUpload(input) {
                const file = input.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const bank = JSON.parse(text);
                    if (!bank.questions || !Array.isArray(bank.questions)) throw new Error("Invalid JSON format");
                    
                    this.data.banks.push(bank);
                    this.saveBanks();
                    this.navigate('home');
                } catch (e) {
                     alert("That file doesn't look like a valid question bank. " + e.message);
                }
            },
            

            deleteBank(index) {
                if(confirm("Are you sure you want to delete this question bank?")) {
                    this.data.banks.splice(index, 1);
                    this.saveBanks();
                    this.renderHome(); // Re-render
                    // Refresh page to clear list cleanly
                    this.navigate('home');
                }
            },

            exportBank(index) {
                const bank = this.data.banks[index];
                if (!bank) return alert("Bank data not found");
                alert("Preparing export for: " + bank.name);

                try {
                    const dataStr = JSON.stringify(bank, null, 2);
                    const blob = new Blob([dataStr], { type: "application/json" });
                    const url = window.URL.createObjectURL(blob);
                    
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = (bank.name || 'bank').replace(/[^a-z0-9]/gi, '_').toLowerCase() + ".json";
                    
                    document.body.appendChild(link);
                    link.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                    }, 500);
                } catch (err) {
                    alert("Export failed: " + err.message);
                    console.error("Export error:", err);
                }
            },

            copyBankToClipboard(index) {
                const bank = this.data.banks[index];
                if (!bank) return;
                
                try {
                    const dataStr = JSON.stringify(bank, null, 2);
                    navigator.clipboard.writeText(dataStr).then(() => {
                        alert("Question bank data copied to clipboard! You can paste it into a text file.");
                    }).catch(err => {
                        // Fallback for older browsers
                        const el = document.createElement('textarea');
                        el.value = dataStr;
                        document.body.appendChild(el);
                        el.select();
                        document.execCommand('copy');
                        document.body.removeChild(el);
                        alert("Question bank data copied to clipboard!");
                    });
                } catch (err) {
                    alert("Copy failed: " + err.message);
                }
            },

            showImportError(e) {
                const errDiv = document.getElementById('import-error');
                const msgDiv = document.getElementById('error-message');
                errDiv.classList.remove('hidden');
                
                // "5 year old idiot" friendly messages
                let friendlyMsg = e.message;
                if (e.message.includes('password')) friendlyMsg = "This PDF is locked with a password. Please unlock it first.";
                if (e.message.includes('Invalid PDF structure')) friendlyMsg = "This file is broken or not a real PDF.";
                
                msgDiv.innerHTML = `
                    <p class="font-bold">Computer says no:</p>
                    <p>${friendlyMsg}</p>
                    <p class="mt-2 text-xs">Technical details: ${e.message}</p>
                `;
            },

            // --- PDF Parsing Logic ---
            async parsePdf(pdf) {
                const questions = [];
                let currentQuestion = null;
                let buffer = [];
                let textLines = [];

                // 1. Extract and sort text (keep existing logic)
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    const lines = {}; 
                    content.items.forEach(item => {
                        const y = Math.round(item.transform[5]); 
                        if (!lines[y]) lines[y] = [];
                        lines[y].push({
                            text: item.str,
                            x: item.transform[4],
                            hasMark: item.str.includes('*'), 
                            isBold: item.fontName.toLowerCase().includes('bold')
                        });
                    });
                    const sortedY = Object.keys(lines).sort((a, b) => b - a);
                    sortedY.forEach(y => {
                        lines[y].sort((a, b) => a.x - b.x);
                        const lineText = lines[y].map(item => item.text).join(' ').trim();
                        const hasMark = lines[y].some(item => item.hasMark);
                        const boldCount = lines[y].filter(i => i.isBold).length;
                        const isLineBold = lines[y].length > 0 && (boldCount / lines[y].length) > 0.5;
                        if (lineText) textLines.push({ text: lineText, hasMark: hasMark, isBold: isLineBold });
                    });
                }

                // 2. Parse Logic
                const saveCurrent = () => {
                    if (currentQuestion && currentQuestion.choices.length > 0) {
                        if (currentQuestion.correctIndex === -1) currentQuestion.correctIndex = 0;
                        questions.push(currentQuestion);
                    }
                };

                // Regex definitions
                const reQuestionNum = /^((?:Q|Question\s*)?\d+)[\.\)](.+)/i;
                const reChoice = /^(\(?[a-zA-Z]\)|[a-zA-Z]\.|^\(?[ivxIVX]+\))(.+)/;
                // Helper to check if a choice is "sequential" roughly (a -> b) or "start" (a)
                const isStartChoice = (str) => /^(a|i)[\.\)]/i.test(str) || /^\((a|i)\)/i.test(str);

                for(let i=0; i<textLines.length; i++) {
                    let lineObj = textLines[i];
                    let text = lineObj.text.trim();
                    let isCorrect = lineObj.hasMark || lineObj.isBold;
                    if (lineObj.hasMark) text = text.replace(/\*/g, '').trim();

                    if (!text) continue;

                    const matchNum = text.match(reQuestionNum);
                    const matchChoice = text.match(reChoice);
                    const isLowerStart = /^[a-z]/.test(text) && !matchChoice;

                    // CASE 1: EXPLICIT NEW QUESTION (Starts with "1.")
                    if (matchNum) {
                        saveCurrent();
                        currentQuestion = {
                            id: Date.now() + Math.random(),
                            text: matchNum[2].trim(),
                            choices: [],
                            correctIndex: -1
                        };
                        buffer = [];
                        continue;
                    }

                    // CASE 2: CHOICE
                    if (matchChoice) {
                        const choiceVal = matchChoice[2].trim();
                        
                        // Check if this triggers a NEW Implicit Question
                        // Trigger if:
                        // 1. We have no current question yet.
                        // 2. We have a current question, but this choice looks like 'a' or 'i' AND we already have choices in current question.
                        //    (e.g. we had a,b,c,d now seeing 'a' again -> new question)
                        let isRestart = false;
                        if (currentQuestion && currentQuestion.choices.length > 0) {
                            if (isStartChoice(matchChoice[0])) isRestart = true;
                        } else if (!currentQuestion) {
                            isRestart = true;
                        }

                        if (isRestart) {
                            // Create question from Buffer
                            saveCurrent();
                            // Filter buffer: remove clearly ignorable lowercase lines unless they look like math/continuation
                            // Rule: "sentence above choice 'a' is the question"
                            // We take the whole buffer. 
                            let qText = buffer.join(' ').trim();
                            if (!qText) qText = "Question Text Not Detected";

                            currentQuestion = {
                                id: Date.now() + Math.random(),
                                text: qText,
                                choices: [],
                                correctIndex: -1
                            };
                            buffer = [];
                        }

                        // Add Choice
                        if (currentQuestion) {
                            currentQuestion.choices.push(choiceVal);
                            if (isCorrect) currentQuestion.correctIndex = currentQuestion.choices.length - 1;
                        }
                        continue;
                    }

                    // CASE 3: REGULAR TEXT
                    // Rule: "Remarks or references that appear in lowercase... should not be included"
                    if (isLowerStart) {
                        // Skip isolated lowercase lines (remarks)
                        // UNLESS we are currently building a question text (no choices yet) and it seems like continuation?
                        // The user was strict: "don't mixed up... don't put into choice or question"
                        // Safer to skip.
                        continue;
                    }

                    if (currentQuestion && currentQuestion.choices.length === 0) {
                        // We are inside a question, appending to its text
                        currentQuestion.text += " " + text;
                    } else {
                        // We are between questions (or before first question), append to buffer
                        buffer.push(text);
                    }
                }

                saveCurrent();
                return questions;
            },

            // --- Editing Logic ---
            editBank(index) {
                this.data.currentBankIndex = index;
                // Deep copy to avoid direct mutation until save
                this.data.tempBank = JSON.parse(JSON.stringify(this.data.banks[index]));
                this.navigate('edit');
            },

            renderEdit() {
                const bank = this.data.tempBank;
                document.getElementById('edit-bank-title').innerText = bank.name;
                document.getElementById('edit-question-count').innerText = `${bank.questions.length} questions`;
                
                const container = document.getElementById('questions-editor');
                container.innerHTML = '';
                
                bank.questions.forEach((q, qIndex) => {
                    const el = document.createElement('div');
                    el.className = 'bg-white p-4 rounded shadow border border-gray-200';
                    el.innerHTML = `
                        <div class="flex justify-between mb-2">
                            <span class="font-bold text-gray-500">#${qIndex + 1}</span>
                            <button onclick="app.removeQuestion(${qIndex})" class="text-red-500 text-sm hover:underline">Delete</button>
                        </div>
                        <div class="mb-3">
                            <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Question</label>
                            <textarea onchange="app.updateQuestionText(${qIndex}, this.value)" class="w-full border rounded p-2 text-sm" rows="2">${q.text}</textarea>
                        </div>
                        <div class="mb-3">
                             <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Image</label>
                             ${q.image ? `<img src="${q.image}" class="h-20 mb-2 border"> <button onclick="app.removeImage(${qIndex})" class="text-xs text-red-500">Remove Image</button>` : ''}
                             <input type="file" accept="image/*" onchange="app.uploadImage(${qIndex}, this)" class="text-xs">
                        </div>
                        <div class="space-y-2">
                            <label class="block text-xs font-bold uppercase text-gray-500">Choices (Check correct answer)</label>
                            ${q.choices.map((c, cIndex) => `
                                <div class="flex items-center space-x-2">
                                    <input type="radio" name="q-${qIndex}-correct" ${cIndex === q.correctIndex ? 'checked' : ''} onchange="app.setCorrectIndex(${qIndex}, ${cIndex})">
                                    <input type="text" value="${c}" onchange="app.updateChoice(${qIndex}, ${cIndex}, this.value)" class="flex-1 border rounded px-2 py-1 text-sm">
                                    <button onclick="app.removeChoice(${qIndex}, ${cIndex})" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                                </div>
                            `).join('')}
                            <button onclick="app.addChoice(${qIndex})" class="text-xs text-blue-500 hover:underline">+ Add Choice</button>
                        </div>
                    `;
                    container.appendChild(el);
                });
            },

            updateQuestionText(qIndex, val) { this.data.tempBank.questions[qIndex].text = val; },
            updateChoice(qIndex, cIndex, val) { this.data.tempBank.questions[qIndex].choices[cIndex] = val; },
            setCorrectIndex(qIndex, cIndex) { this.data.tempBank.questions[qIndex].correctIndex = cIndex; },
            
            addChoice(qIndex) { 
                this.data.tempBank.questions[qIndex].choices.push("New Option"); 
                this.renderEdit(); 
            },
            removeChoice(qIndex, cIndex) {
                this.data.tempBank.questions[qIndex].choices.splice(cIndex, 1);
                // Adjust correct index if needed
                if(this.data.tempBank.questions[qIndex].correctIndex === cIndex) {
                    this.data.tempBank.questions[qIndex].correctIndex = -1;
                } else if (this.data.tempBank.questions[qIndex].correctIndex > cIndex) {
                    this.data.tempBank.questions[qIndex].correctIndex--;
                }
                this.renderEdit();
            },
            addEmptyQuestion() {
                this.data.tempBank.questions.push({ text: "New Question", choices: ["Option A", "Option B"], correctIndex: 0 });
                this.renderEdit();
                // Scroll to bottom
                setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 100);
            },
            removeQuestion(qIndex) {
                if(confirm("Delete this question?")) {
                    this.data.tempBank.questions.splice(qIndex, 1);
                    this.renderEdit();
                }
            },
            
            uploadImage(qIndex, input) {
                const file = input.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.data.tempBank.questions[qIndex].image = e.target.result;
                        this.renderEdit();
                    };
                    reader.readAsDataURL(file);
                }
            },
            removeImage(qIndex) {
                delete this.data.tempBank.questions[qIndex].image;
                this.renderEdit();
            },

            saveBankEdit() {
                this.data.banks[this.data.currentBankIndex] = this.data.tempBank;
                this.saveBanks();
                this.navigate('home');
            },

            // --- Practice Logic ---
            setupPractice(index) {
                this.data.currentBankIndex = index;
                this.navigate('practice-setup');
                
                // Defaults
                const bank = this.data.banks[index];
                document.getElementById('practice-count').value = bank.questions.length;
                document.getElementById('practice-count').max = bank.questions.length;
                
                // Resume check
                const saved = localStorage.getItem('mcq_practice_session');
                if (saved) {
                    const session = JSON.parse(saved);
                    // Only show resume if it matches current bank
                    // Since we don't have IDs, we'll assume user knows what they're doing or we could add IDs later.
                    // For now, simpler:
                    document.getElementById('resume-container').classList.remove('hidden');
                }
            },

            setPracticeMode(mode) {
                const btnStd = document.getElementById('mode-std');
                const btnRds = document.getElementById('mode-rds');
                const desc = document.getElementById('mode-desc');
                
                if (mode === 'standard') {
                    btnStd.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                    btnStd.classList.remove('text-gray-600', 'border-gray-300');
                    btnRds.classList.remove('bg-purple-600', 'text-white', 'border-purple-600');
                    btnRds.classList.add('text-gray-600', 'border-gray-300');
                    desc.innerText = "Immediate feedback after every question.";
                } else {
                    btnRds.classList.add('bg-purple-600', 'text-white', 'border-purple-600');
                    btnRds.classList.remove('text-gray-600', 'border-gray-300');
                    btnStd.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                    btnStd.classList.add('text-gray-600', 'border-gray-300');
                    desc.innerText = "Real Dope Shit Mode: No feedback until the end. Exam style.";
                }
                btnStd.dataset.selected = mode === 'standard';
            },

            startPractice() {
                const bank = this.data.banks[this.data.currentBankIndex];
                const count = parseInt(document.getElementById('practice-count').value) || bank.questions.length;
                const shuffle = document.getElementById('practice-shuffle').checked;
                const isStd = document.getElementById('mode-std').dataset.selected !== 'false'; // Default true
                
                let questions = [...bank.questions];
                if (shuffle) {
                    questions = questions.sort(() => Math.random() - 0.5);
                }
                questions = questions.slice(0, count);

                this.data.practiceSession = {
                    questions: questions,
                    currentIndex: 0,
                    score: 0,
                    mode: isStd ? 'standard' : 'rds',
                    answers: {}, // Store user answers
                    finished: false
                };

                this.saveSession();
                this.navigate('practice');
            },
            
            resumePractice() {
                const saved = localStorage.getItem('mcq_practice_session');
                if (saved) {
                    this.data.practiceSession = JSON.parse(saved);
                    this.navigate('practice');
                }
            },

            saveSession() {
                localStorage.setItem('mcq_practice_session', JSON.stringify(this.data.practiceSession));
            },
            
            saveAndQuit() {
                this.saveSession();
                this.navigate('home');
            },

            renderPractice() {
                const session = this.data.practiceSession;
                if (!session) return;
                
                // Update header
                document.getElementById('p-current').innerText = session.currentIndex + 1;
                document.getElementById('p-total').innerText = session.questions.length;
                document.getElementById('p-score').innerText = session.score;
                
                // Score visibility
                if (session.mode === 'rds') {
                    document.getElementById('score-display').classList.add('hidden');
                } else {
                    document.getElementById('score-display').classList.remove('hidden');
                }

                // Render Question
                const q = session.questions[session.currentIndex];
                document.getElementById('p-question-text').innerText = q.text;
                
                const imgDiv = document.getElementById('p-question-image');
                if (q.image) {
                    imgDiv.classList.remove('hidden');
                    imgDiv.querySelector('img').src = q.image;
                } else {
                    imgDiv.classList.add('hidden');
                }

                // Render Choices
                const choicesDiv = document.getElementById('p-choices');
                choicesDiv.innerHTML = '';
                const feedbackDiv = document.getElementById('p-feedback');
                feedbackDiv.classList.add('hidden');
                feedbackDiv.className = 'mt-6 hidden p-4 rounded-lg'; // reset classes

                const userAnswer = session.answers[session.currentIndex];
                const isAnswered = userAnswer !== undefined;

                q.choices.forEach((c, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'w-full text-left p-3 rounded border border-gray-200 hover:bg-gray-50 transition flex items-start';
                    
                    // Styling based on state
                    if (isAnswered) {
                         if (session.mode === 'standard') {
                             if (idx === q.correctIndex) {
                                 btn.classList.add('bg-green-100', 'border-green-500');
                                 btn.innerHTML += '<i class="fas fa-check text-green-600 mt-1 mr-2"></i>';
                             } else if (idx === userAnswer && idx !== q.correctIndex) {
                                 btn.classList.add('bg-red-100', 'border-red-500');
                                  btn.innerHTML += '<i class="fas fa-times text-red-600 mt-1 mr-2"></i>';
                             } else {
                                 btn.classList.add('opacity-50');
                             }
                         } else {
                             // RDS Mode - just highlight selected
                             if (idx === userAnswer) {
                                 btn.classList.add('bg-blue-100', 'border-blue-500');
                             }
                         }
                    } else {
                        btn.onclick = () => app.handleAnswer(idx);
                    }

                    btn.innerHTML += `<span>${c}</span>`;
                    choicesDiv.appendChild(btn);
                });

                // Feedback (Standard Mode only)
                if (isAnswered && session.mode === 'standard') {
                    feedbackDiv.classList.remove('hidden');
                    if (userAnswer === q.correctIndex) {
                        feedbackDiv.classList.add('bg-green-100', 'text-green-800');
                        feedbackDiv.innerHTML = '<strong>Correct!</strong> Good job.';
                    } else {
                        feedbackDiv.classList.add('bg-red-100', 'text-red-800');
                        feedbackDiv.innerHTML = `<strong>Incorrect.</strong> The correct answer is: ${q.choices[q.correctIndex]}`;
                    }
                }

                // Navigation Button Logic
                const btnNext = document.getElementById('btn-next');
                const btnSubmit = document.getElementById('btn-submit-exam');
                const isLast = session.currentIndex === session.questions.length - 1;
                
                // Use inline styles to guarantee visibility changes
                if (isLast) {
                    btnNext.style.display = 'none';
                    btnSubmit.style.display = 'block';
                    btnSubmit.classList.remove('hidden'); // Tailwind backup
                    btnSubmit.innerText = session.mode === 'rds' ? 'Submit Exam' : 'Finish Practice';
                    btnSubmit.onclick = () => app.submitExam();
                } else {
                    btnNext.style.display = 'block';
                    btnNext.classList.remove('hidden'); // Tailwind backup
                    btnSubmit.style.display = 'none';
                    btnNext.innerText = 'Next';
                }
            },

            handleAnswer(choiceIndex) {
                const session = this.data.practiceSession;
                session.answers[session.currentIndex] = choiceIndex;
                
                if (session.mode === 'standard') {
                    if (choiceIndex === session.questions[session.currentIndex].correctIndex) {
                        session.score++;
                    }
                }
                
                this.saveSession();
                this.renderPractice();
            },

            nextQuestion() {
                const session = this.data.practiceSession;
                if (session.currentIndex < session.questions.length - 1) {
                    session.currentIndex++;
                    this.saveSession();
                    this.renderPractice();
                }
            },

            prevQuestion() {
                 const session = this.data.practiceSession;
                if (session.currentIndex > 0) {
                    session.currentIndex--;
                    this.saveSession();
                    this.renderPractice();
                }
            },
            
            submitExam() {
                const session = this.data.practiceSession;
                // Calculate score
                session.score = 0;
                session.questions.forEach((q, idx) => {
                    if (session.answers[idx] === q.correctIndex) {
                        session.score++;
                    }
                });
                
                this.finishPractice();
            },
            
            finishPractice() {
                const session = this.data.practiceSession;
                localStorage.removeItem('mcq_practice_session');
                
                const container = document.getElementById('app-container');
                const template = document.getElementById('view-result');
                
                if (!template) return alert("Error: Template missing");
                
                container.innerHTML = '';
                container.appendChild(template.content.cloneNode(true));
                
                // Score Header
                const percentage = Math.round((session.score / session.questions.length) * 100) || 0;
                const scoreEl = document.getElementById('result-score');
                const detailEl = document.getElementById('result-detail');
                
                if(scoreEl) {
                    scoreEl.innerText = `${percentage}%`;
                    scoreEl.className = `text-6xl font-bold my-6 ${percentage < 50 ? 'text-red-600' : (percentage > 80 ? 'text-green-600' : 'text-blue-600')}`;
                }
                if(detailEl) detailEl.innerText = `You got ${session.score} out of ${session.questions.length} correct.`;
                
                // Wrong Answers
                const list = document.getElementById('result-wrong-list');
                const section = document.getElementById('wrong-answers-section');
                
                if (!list || !section) return; 
                
                let wrongCount = 0;
                session.questions.forEach((q, idx) => {
                    const userAnswer = session.answers[idx];
                    // Strict comparison for wrong answer
                    if (userAnswer !== q.correctIndex) {
                        wrongCount++;
                        const item = document.createElement('div');
                        item.className = 'bg-white border-l-4 border-red-500 shadow-sm p-4 rounded mb-4';
                        
                        let userText = '<span class="text-gray-400 italic">No Answer</span>';
                        if (userAnswer !== undefined && userAnswer !== null && q.choices[userAnswer]) {
                            userText = q.choices[userAnswer];
                        }
                        
                        const correctText = q.choices[q.correctIndex] || '<span class="text-gray-400 italic">Unknown</span>';
                        
                        item.innerHTML = `
                            <div class="mb-2 font-medium text-gray-800"><span class="text-red-500 font-bold">Q${idx+1}.</span> ${q.text}</div>
                            ${q.image ? `<img src="${q.image}" class="h-24 mb-2 object-contain border">` : ''}
                            <div class="grid grid-cols-1 gap-2 text-sm">
                                <div class="bg-red-50 p-2 rounded text-red-800"><i class="fas fa-times-circle mr-2"></i>You chose: <strong>${userText}</strong></div>
                                <div class="bg-green-50 p-2 rounded text-green-800"><i class="fas fa-check-circle mr-2"></i>Correct answer: <strong>${correctText}</strong></div>
                            </div>
                        `;
                        list.appendChild(item);
                    }
                });
                
                if (wrongCount === 0) {
                    section.innerHTML = `
                        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative text-center" role="alert">
                            <strong class="font-bold">Perfect!</strong>
                            <span class="block sm:inline">You got everything right. Amazing!</span>
                        </div>`;
                }
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
